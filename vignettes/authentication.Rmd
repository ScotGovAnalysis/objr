---
title: "Authentication"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Authentication}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  eval = FALSE
)
```

## How authentication works

The first time you send a request, the API requires your Objective Connect user email address and password to authenticate. This is called "Basic" authentication.

Each successful response from the API includes a token. This token can then be used to authenticate subsequent requests in your session, negating the need to repeatedly supply your email address and password. This is called "Session" authentication.

The rest of this article details how to manage authentication when using the `objr` package, including handling [multi-factor authentication](#mfa) (including two-factor and mobile authentication).


## First request

You will need your Objective Connect user email address and password to make a first request to the API. These can be provided in two ways.

### R Environment variables

Add two variables to your `.Renviron` file to define your email address and password.
  
* Open your `.Renviron` file to edit:
  
  ```{r open_renviron}
  usethis::edit_r_environ()
  ```
  
* Add two variables as follows (replacing `XXX` with your credentials):

  ```{r add_vars}
  OBJR_USR = "XXX"
  OBJR_PWD = "XXX"
  ```

* Save and close the `.Renviron` file.

* To check this has worked as expected, first restart your R session then run:

  ```{r check_vars}
  Sys.getenv("OBJR_USR")
  Sys.getenv("OBJR_PWD")
  ```
  
  Your credentials should be printed in the console. 
  
  Note: It is important not to save your R session workspace on close as your console may contain your Objective Connect credentials.

The benefit of this method is that you can leave this information in your `.Renviron` file and `objr` will automatically find them here each time you use the package. 


### Supply credentials when prompted

If you don't have these variables defined in your `.Renviron` file, `objr` will prompt you to supply them if you're working in an interactive session.

```{r}
#| eval: true
#| echo: false
#| fig-align: "center"
#| fig-alt: >
#|    A small pop-up window with prompt 'Enter email registered with Objective
#|    Connect' followed by a text input box and buttons to select 'OK' or
#|    'Cancel'.
knitr::include_graphics("auth_prompt.png", dpi = "retina")
```


## Subsequent requests

Each successful API response includes a token that can be used for subsequent requests. `objr` functions automatically parse this token from the API response and store it in your R session's global environment (as `token`).

Where this object exists, `objr` will automatically use it to authenticate subsequent requests. 

If this object doesn't exist, `objr` will resort to using your username and password, as it did for your [first request](#first-request).

Tokens become invalid when your session expires. If you have an invalid token in your environment, your API request will fail and you will be prompted to remove the token and try again using your username and password.


## Multi-factor authentication {#mfa}

### Two-factor authentication

Two-factor authentication (2FA) may be enforced in some workspaces. When using Objective Connect in your browser, this means you will need to enter a code that has been emailed to you before completing certain tasks. 

To use `objr` in these workspaces, users must be given permission to bypass 2FA. More information and guidance to set this up is available in the [Two-factor authentication article](./two-factor.html).

### Mobile authentication {#mobileauth}

Mobile authentication may be enforced in some workspaces, or you may have enabled this yourself. [Guidance to enable, register or disable mobile authentication](https://helpdocs.objective.com/objectiveconnect/K_AdminFunctions/ManagingMobileAuth.htm) is available in the Objective Connect Help documentation.

You can view the status of mobile authentication on your account using `mobile_auth_status()`. For example:

```{r mobile_auth_status}
mobile_auth_status()
```

```{r mobile_auth_status_output, eval = TRUE, echo = FALSE}
list(mobileAuthLogin = TRUE, mobileAuthRegistered = TRUE)
```

If you have both enabled mobile authentication and registered a mobile device, you will need to login using mobile authentication before using any other `objr` functionality. This can be done using `mobile_auth_login()`. This function requires [username and password authentication](#first-request) as with any other first request.

You can either provide the authentication code from your mobile device directly to the function:

```{r login-1}
mobile_auth_status("123456")
```

Or, if left empty, you will be prompted to enter your code in a pop-up window:

```{r login-2}
mobile_auth_status()
```

```{r}
#| eval: true
#| echo: false
#| fig-align: "center"
#| fig-alt: >
#|    A small pop-up window with prompt 'Enter mobile authentication code' 
#|    followed by a text input box and buttons to select 'OK' or 'Cancel'.
knitr::include_graphics("mobileauth_prompt.png", dpi = "retina")
```

```{r mobile_auth_login_output, eval = TRUE, echo = FALSE, message = TRUE}
cli::cli_alert_success(
  "Successfully logged in via Mobile Authenticator."
)
```

If login is successful, the token from the API response is stored automatically and used for [subsequent requests](#subsequent-requests). Tokens become invalid when your session expires. If you have an invalid token in your environment, your API request will fail and you will need to login using your mobile authenticator again.

Mobile authentication login attempts are limited to a maximum of 5 failures within a 5-minute interval. After 5 failed attempts, your Objective Connect account will be locked. To regain access, wait for 5 mins and then try logging in again.
